import * as cdk from "aws-cdk-lib";
import { Duration, Size } from "aws-cdk-lib";
import * as asg from "aws-cdk-lib/aws-applicationautoscaling";
import * as aws_cloudwatch from "aws-cdk-lib/aws-cloudwatch";
import * as aws_cloudwatch_actions from "aws-cdk-lib/aws-cloudwatch-actions";
import * as aws_iam from "aws-cdk-lib/aws-iam";
import * as aws_lambda from "aws-cdk-lib/aws-lambda";
import * as aws_lambda_nodejs from "aws-cdk-lib/aws-lambda-nodejs";
import * as aws_sns from "aws-cdk-lib/aws-sns";
import * as path from "path";
import { DynamoDBTableProps } from "./routing-database-stack";
import { RetentionDays } from "aws-cdk-lib/aws-logs";
export class RoutingLambdaStack extends cdk.NestedStack {
    constructor(scope, name, props) {
        super(scope, name, props);
        const { poolCacheBucket, poolCacheBucket2, poolCacheKey, jsonRpcProviders, tokenListCacheBucket, provisionedConcurrency, ethGasStationInfoUrl, chatbotSNSArn, tenderlyUser, tenderlyProject, tenderlyAccessKey, routesDynamoDb, routesDbCachingRequestFlagDynamoDb, cachedRoutesDynamoDb, cachingRequestFlagDynamoDb, cachedV3PoolsDynamoDb, tokenPropertiesCachingDynamoDb, unicornSecret, } = props;
        const lambdaRole = new aws_iam.Role(this, "RoutingLambdaRole", {
            assumedBy: new aws_iam.ServicePrincipal("lambda.amazonaws.com"),
            managedPolicies: [
                aws_iam.ManagedPolicy.fromAwsManagedPolicyName("service-role/AWSLambdaBasicExecutionRole"),
                aws_iam.ManagedPolicy.fromAwsManagedPolicyName("service-role/AWSLambdaRole"),
                aws_iam.ManagedPolicy.fromAwsManagedPolicyName("CloudWatchLambdaInsightsExecutionRolePolicy"),
                aws_iam.ManagedPolicy.fromAwsManagedPolicyName("AWSXRayDaemonWriteAccess"),
            ],
        });
        poolCacheBucket.grantRead(lambdaRole);
        poolCacheBucket2.grantRead(lambdaRole);
        tokenListCacheBucket.grantRead(lambdaRole);
        routesDynamoDb.grantReadWriteData(lambdaRole);
        routesDbCachingRequestFlagDynamoDb.grantReadWriteData(lambdaRole);
        cachedRoutesDynamoDb.grantReadWriteData(lambdaRole);
        cachingRequestFlagDynamoDb.grantReadWriteData(lambdaRole);
        cachedV3PoolsDynamoDb.grantReadWriteData(lambdaRole);
        tokenPropertiesCachingDynamoDb.grantReadWriteData(lambdaRole);
        const region = cdk.Stack.of(this).region;
        this.routingLambda = new aws_lambda_nodejs.NodejsFunction(this, "RoutingLambda2", {
            role: lambdaRole,
            runtime: aws_lambda.Runtime.NODEJS_18_X,
            entry: path.join(__dirname, "../../lib/handlers/index.ts"),
            handler: "quoteHandler",
            // 11/8/23: URA currently calls the Routing API with a timeout of 10 seconds.
            // Set this lambda's timeout to be slightly lower to give them time to
            // log the response in the event of a failure on our end.
            timeout: cdk.Duration.seconds(9),
            memorySize: 1792,
            ephemeralStorageSize: Size.gibibytes(1),
            deadLetterQueueEnabled: true,
            bundling: {
                minify: true,
                sourceMap: true,
            },
            awsSdkConnectionReuse: true,
            description: "Routing Lambda",
            environment: {
                VERSION: "6",
                NODE_OPTIONS: "--enable-source-maps",
                POOL_CACHE_BUCKET: poolCacheBucket.bucketName,
                POOL_CACHE_BUCKET_2: poolCacheBucket2.bucketName,
                POOL_CACHE_KEY: poolCacheKey,
                TOKEN_LIST_CACHE_BUCKET: tokenListCacheBucket.bucketName,
                ETH_GAS_STATION_INFO_URL: ethGasStationInfoUrl,
                TENDERLY_USER: tenderlyUser,
                TENDERLY_PROJECT: tenderlyProject,
                TENDERLY_ACCESS_KEY: tenderlyAccessKey,
                // WARNING: Dynamo table name should be the tableinstance.name, e.g. routesDynamoDb.tableName.
                //          But we tried and had seen lambd version error:
                //          The following resource(s) failed to create: [RoutingLambda2CurrentVersion49A1BB948389ce4f9c26b15e2ccb07b4c1bab726].
                //          2023-09-01 10:22:43 UTC-0700RoutingLambda2CurrentVersion49A1BB948389ce4f9c26b15e2ccb07b4c1bab726CREATE_FAILED
                //          A version for this Lambda function exists ( 261 ). Modify the function to create a new version.
                //          Hence we do not want to modify the table name below.
                ROUTES_TABLE_NAME: DynamoDBTableProps.RoutesDbTable.Name,
                ROUTES_CACHING_REQUEST_FLAG_TABLE_NAME: DynamoDBTableProps.RoutesDbCachingRequestFlagTable.Name,
                CACHED_ROUTES_TABLE_NAME: DynamoDBTableProps.CacheRouteDynamoDbTable.Name,
                CACHING_REQUEST_FLAG_TABLE_NAME: DynamoDBTableProps.CachingRequestFlagDynamoDbTable.Name,
                CACHED_V3_POOLS_TABLE_NAME: DynamoDBTableProps.V3PoolsDynamoDbTable.Name,
                // tokenPropertiesCachingDynamoDb.tableName is the correct format.
                // we will start using the correct ones going forward
                TOKEN_PROPERTIES_CACHING_TABLE_NAME: tokenPropertiesCachingDynamoDb.tableName,
                UNICORN_SECRET: unicornSecret,
                ...jsonRpcProviders,
            },
            layers: [
                aws_lambda.LayerVersion.fromLayerVersionArn(this, "InsightsLayer", `arn:aws:lambda:${region}:580247275435:layer:LambdaInsightsExtension:14`),
            ],
            tracing: aws_lambda.Tracing.ACTIVE,
            logRetention: RetentionDays.TWO_WEEKS,
        });
        const lambdaAlarmErrorRate = new aws_cloudwatch.Alarm(this, "RoutingAPI-LambdaErrorRate", {
            metric: new aws_cloudwatch.MathExpression({
                expression: "errors / invocations",
                usingMetrics: {
                    errors: this.routingLambda.metricErrors({
                        period: Duration.minutes(5),
                        statistic: "avg",
                    }),
                    invocations: this.routingLambda.metricInvocations({
                        period: Duration.minutes(5),
                        statistic: "avg",
                    }),
                },
            }),
            threshold: 0.05,
            evaluationPeriods: 3,
        });
        const lambdaThrottlesErrorRate = new aws_cloudwatch.Alarm(this, "RoutingAPI-LambdaThrottles", {
            metric: this.routingLambda.metricThrottles({
                period: Duration.minutes(5),
                statistic: "sum",
            }),
            threshold: 10,
            evaluationPeriods: 3,
        });
        if (chatbotSNSArn) {
            const chatBotTopic = aws_sns.Topic.fromTopicArn(this, "ChatbotTopic", chatbotSNSArn);
            lambdaAlarmErrorRate.addAlarmAction(new aws_cloudwatch_actions.SnsAction(chatBotTopic));
            lambdaThrottlesErrorRate.addAlarmAction(new aws_cloudwatch_actions.SnsAction(chatBotTopic));
        }
        const enableProvisionedConcurrency = provisionedConcurrency > 0;
        this.routingLambdaAlias = new aws_lambda.Alias(this, "RoutingLiveAlias", {
            aliasName: "live",
            version: this.routingLambda.currentVersion,
            provisionedConcurrentExecutions: enableProvisionedConcurrency ? provisionedConcurrency : undefined,
        });
        if (enableProvisionedConcurrency) {
            const target = new asg.ScalableTarget(this, "RoutingProvConcASG", {
                serviceNamespace: asg.ServiceNamespace.LAMBDA,
                maxCapacity: provisionedConcurrency * 5,
                minCapacity: provisionedConcurrency,
                resourceId: `function:${this.routingLambdaAlias.lambda.functionName}:${this.routingLambdaAlias.aliasName}`,
                scalableDimension: "lambda:function:ProvisionedConcurrency",
            });
            target.node.addDependency(this.routingLambdaAlias);
            target.scaleToTrackMetric("RoutingProvConcTracking", {
                targetValue: 0.8,
                predefinedMetric: asg.PredefinedMetric.LAMBDA_PROVISIONED_CONCURRENCY_UTILIZATION,
            });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGluZy1sYW1iZGEtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9iaW4vc3RhY2tzL3JvdXRpbmctbGFtYmRhLXN0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxHQUFHLE1BQU0sYUFBYSxDQUFDO0FBQ25DLE9BQU8sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTdDLE9BQU8sS0FBSyxHQUFHLE1BQU0sd0NBQXdDLENBQUM7QUFDOUQsT0FBTyxLQUFLLGNBQWMsTUFBTSw0QkFBNEIsQ0FBQztBQUM3RCxPQUFPLEtBQUssc0JBQXNCLE1BQU0sb0NBQW9DLENBQUM7QUFDN0UsT0FBTyxLQUFLLE9BQU8sTUFBTSxxQkFBcUIsQ0FBQztBQUMvQyxPQUFPLEtBQUssVUFBVSxNQUFNLHdCQUF3QixDQUFDO0FBQ3JELE9BQU8sS0FBSyxpQkFBaUIsTUFBTSwrQkFBK0IsQ0FBQztBQUVuRSxPQUFPLEtBQUssT0FBTyxNQUFNLHFCQUFxQixDQUFDO0FBRS9DLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzlELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQXNCckQsTUFBTSxPQUFPLGtCQUFtQixTQUFRLEdBQUcsQ0FBQyxXQUFXO0lBSXJELFlBQVksS0FBZ0IsRUFBRSxJQUFZLEVBQUUsS0FBOEI7UUFDeEUsS0FBSyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDMUIsTUFBTSxFQUNKLGVBQWUsRUFDZixnQkFBZ0IsRUFDaEIsWUFBWSxFQUNaLGdCQUFnQixFQUNoQixvQkFBb0IsRUFDcEIsc0JBQXNCLEVBQ3RCLG9CQUFvQixFQUNwQixhQUFhLEVBQ2IsWUFBWSxFQUNaLGVBQWUsRUFDZixpQkFBaUIsRUFDakIs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Q25HLENBQUMsQ0FBQztRQUVILElBQUksNEJBQTRCLEVBQUU7WUFDaEMsTUFBTSxNQUFNLEdBQUcsSUFBSSxHQUFHLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxvQkFBb0IsRUFBRTtnQkFDaEUsZ0JBQWdCLEVBQUUsR0FBRyxDQUFDLGdCQUFnQixDQUFDLE1BQU07Z0JBQzdDLFdBQVcsRUFBRSxzQkFBc0IsR0FBRyxDQUFDO2dCQUN2QyxXQUFXLEVBQUUsc0JBQXNCO2dCQUNuQyxVQUFVLEVBQUUsWUFBWSxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsa0JBQWtCLENBQUMsU0FBUyxFQUFFO2dCQUMxRyxpQkFBaUIsRUFBRSx3Q0FBd0M7YUFDNUQsQ0FBQyxDQUFDO1lBRUgsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFFbkQsTUFBTSxDQUFDLGtCQUFrQixDQUFDLHlCQUF5QixFQUFFO2dCQUNuRCxXQUFXLEVBQUUsR0FBRztnQkFDaEIsZ0JBQWdCLEVBQUUsR0FBRyxDQUFDLGdCQUFnQixDQUFDLDBDQUEwQzthQUNsRixDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNkayBmcm9tIFwiYXdzLWNkay1saWJcIjtcbmltcG9ydCB7IER1cmF0aW9uLCBTaXplIH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgKiBhcyBhd3NfZHluYW1vZGIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1keW5hbW9kYlwiO1xuaW1wb3J0ICogYXMgYXNnIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtYXBwbGljYXRpb25hdXRvc2NhbGluZ1wiO1xuaW1wb3J0ICogYXMgYXdzX2Nsb3Vkd2F0Y2ggZnJvbSBcImF3cy1jZGstbGliL2F3cy1jbG91ZHdhdGNoXCI7XG5pbXBvcnQgKiBhcyBhd3NfY2xvdWR3YXRjaF9hY3Rpb25zIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtY2xvdWR3YXRjaC1hY3Rpb25zXCI7XG5pbXBvcnQgKiBhcyBhd3NfaWFtIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtaWFtXCI7XG5pbXBvcnQgKiBhcyBhd3NfbGFtYmRhIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgKiBhcyBhd3NfbGFtYmRhX25vZGVqcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYS1ub2RlanNcIjtcbmltcG9ydCAqIGFzIGF3c19zMyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLXMzXCI7XG5pbXBvcnQgKiBhcyBhd3Nfc25zIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtc25zXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgRHluYW1vREJUYWJsZVByb3BzIH0gZnJvbSBcIi4vcm91dGluZy1kYXRhYmFzZS1zdGFja1wiO1xuaW1wb3J0IHsgUmV0ZW50aW9uRGF5cyB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbG9nc1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIFJvdXRpbmdMYW1iZGFTdGFja1Byb3BzIGV4dGVuZHMgY2RrLk5lc3RlZFN0YWNrUHJvcHMge1xuICBwb29sQ2FjaGVCdWNrZXQ6IGF3c19zMy5CdWNrZXQ7XG4gIHBvb2xDYWNoZUJ1Y2tldDI6IGF3c19zMy5CdWNrZXQ7XG4gIHBvb2xDYWNoZUtleTogc3RyaW5nO1xuICBqc29uUnBjUHJvdmlkZXJzOiB7IFtjaGFpbk5hbWU6IHN0cmluZ106IHN0cmluZyB9O1xuICB0b2tlbkxpc3RDYWNoZUJ1Y2tldDogYXdzX3MzLkJ1Y2tldDtcbiAgcHJvdmlzaW9uZWRDb25jdXJyZW5jeTogbnVtYmVyO1xuICBldGhHYXNTdGF0aW9uSW5mb1VybDogc3RyaW5nO1xuICB0ZW5kZXJseVVzZXI6IHN0cmluZztcbiAgdGVuZGVybHlQcm9qZWN0OiBzdHJpbmc7XG4gIHRlbmRlcmx5QWNjZXNzS2V5OiBzdHJpbmc7XG4gIGNoYXRib3RTTlNBcm4/OiBzdHJpbmc7XG4gIHJvdXRlc0R5bmFtb0RiOiBhd3NfZHluYW1vZGIuVGFibGU7XG4gIHJvdXRlc0RiQ2FjaGluZ1JlcXVlc3RGbGFnRHluYW1vRGI6IGF3c19keW5hbW9kYi5UYWJsZTtcbiAgY2FjaGVkUm91dGVzRHluYW1vRGI6IGF3c19keW5hbW9kYi5UYWJsZTtcbiAgY2FjaGluZ1JlcXVlc3RGbGFnRHluYW1vRGI6IGF3c19keW5hbW9kYi5UYWJsZTtcbiAgY2FjaGVkVjNQb29sc0R5bmFtb0RiOiBhd3NfZHluYW1vZGIuVGFibGU7XG4gIHRva2VuUHJvcGVydGllc0NhY2hpbmdEeW5hbW9EYjogYXdzX2R5bmFtb2RiLlRhYmxlO1xuICB1bmljb3JuU2VjcmV0OiBzdHJpbmc7XG59XG5leHBvcnQgY2xhc3MgUm91dGluZ0xhbWJkYVN0YWNrIGV4dGVuZHMgY2RrLk5lc3RlZFN0YWNrIHtcbiAgcHVibGljIHJlYWRvbmx5IHJvdXRpbmdMYW1iZGE6IGF3c19sYW1iZGFfbm9kZWpzLk5vZGVqc0Z1bmN0aW9uO1xuICBwdWJsaWMgcmVhZG9ubHkgcm91dGluZ0xhbWJkYUFsaWFzOiBhd3NfbGFtYmRhLkFsaWFzO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIG5hbWU6IHN0cmluZywgcHJvcHM6IFJvdXRpbmdMYW1iZGFTdGFja1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIG5hbWUsIHByb3BzKTtcbiAgICBjb25zdCB7XG4gICAgICBwb29sQ2FjaGVCdWNrZXQsXG4gICAgICBwb29sQ2FjaGVCdWNrZXQyLFxuICAgICAgcG9vbENhY2hlS2V5LFxuICAgICAganNvblJwY1Byb3ZpZGVycyxcbiAgICAgIHRva2VuTGlzdENhY2hlQnVja2V0LFxuICAgICAgcHJvdmlzaW9uZWRDb25jdXJyZW5jeSxcbiAgICAgIGV0aEdhc1N0YXRpb25JbmZvVXJsLFxuICAgICAgY2hhdGJvdFNOU0FybixcbiAgICAgIHRlbmRlcmx5VXNlcixcbiAgICAgIHRlbmRlcmx5UHJvamVjdCxcbiAgICAgIHRlbmRlcmx5QWNjZXNzS2V5LFxuICAgICAgcm91dGVzRHluYW1vRGIsXG4gICAgICByb3V0ZXNEYkNhY2hpbmdSZXF1ZXN0RmxhZ0R5bmFtb0RiLFxuICAgICAgY2FjaGVkUm91dGVzRHluYW1vRGIsXG4gICAgICBjYWNoaW5nUmVxdWVzdEZsYWdEeW5hbW9EYixcbiAgICAgIGNhY2hlZFYzUG9vbHNEeW5hbW9EYixcbiAgICAgIHRva2VuUHJvcGVydGllc0NhY2hpbmdEeW5hbW9EYixcbiAgICAgIHVuaWNvcm5TZWNyZXQsXG4gICAgfSA9IHByb3BzO1xuXG4gICAgY29uc3QgbGFtYmRhUm9sZSA9IG5ldyBhd3NfaWFtLlJvbGUodGhpcywgXCJSb3V0aW5nTGFtYmRhUm9sZVwiLCB7XG4gICAgICBhc3N1bWVkQnk6IG5ldyBhd3NfaWFtLlNlcnZpY2VQcmluY2lwYWwoXCJsYW1iZGEuYW1hem9uYXdzLmNvbVwiKSxcbiAgICAgIG1hbmFnZWRQb2xpY2llczogW1xuICAgICAgICBhd3NfaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwic2VydmljZS1yb2xlL0FXU0xhbWJkYUJhc2ljRXhlY3V0aW9uUm9sZVwiKSxcbiAgICAgICAgYXdzX2lhbS5NYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZShcInNlcnZpY2Utcm9sZS9BV1NMYW1iZGFSb2xlXCIpLFxuICAgICAgICBhd3NfaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwiQ2xvdWRXYXRjaExhbWJkYUluc2lnaHRzRXhlY3V0aW9uUm9sZVBvbGljeVwiKSxcbiAgICAgICAgYXdzX2lhbS5NYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZShcIkFXU1hSYXlEYWVtb25Xcml0ZUFjY2Vzc1wiKSxcbiAgICAgIF0sXG4gICAgfSk7XG4gICAgcG9vbENhY2hlQnVja2V0LmdyYW50UmVhZChsYW1iZGFSb2xlKTtcbiAgICBwb29sQ2FjaGVCdWNrZXQyLmdyYW50UmVhZChsYW1iZGFSb2xlKTtcbiAgICB0b2tlbkxpc3RDYWNoZUJ1Y2tldC5ncmFudFJlYWQobGFtYmRhUm9sZSk7XG4gICAgcm91dGVzRHluYW1vRGIuZ3JhbnRSZWFkV3JpdGVEYXRhKGxhbWJkYVJvbGUpO1xuICAgIHJvdXRlc0RiQ2FjaGluZ1JlcXVlc3RGbGFnRHluYW1vRGIuZ3JhbnRSZWFkV3JpdGVEYXRhKGxhbWJkYVJvbGUpO1xuICAgIGNhY2hlZFJvdXRlc0R5bmFtb0RiLmdyYW50UmVhZFdyaXRlRGF0YShsYW1iZGFSb2xlKTtcbiAgICBjYWNoaW5nUmVxdWVzdEZsYWdEeW5hbW9EYi5ncmFudFJlYWRXcml0ZURhdGEobGFtYmRhUm9sZSk7XG4gICAgY2FjaGVkVjNQb29sc0R5bmFtb0RiLmdyYW50UmVhZFdyaXRlRGF0YShsYW1iZGFSb2xlKTtcblxuICAgIHRva2VuUHJvcGVydGllc0NhY2hpbmdEeW5hbW9EYi5ncmFudFJlYWRXcml0ZURhdGEobGFtYmRhUm9sZSk7XG5cbiAgICBjb25zdCByZWdpb24gPSBjZGsuU3RhY2sub2YodGhpcykucmVnaW9uO1xuXG4gICAgdGhpcy5yb3V0aW5nTGFtYmRhID0gbmV3IGF3c19sYW1iZGFfbm9kZWpzLk5vZGVqc0Z1bmN0aW9uKHRoaXMsIFwiUm91dGluZ0xhbWJkYTJcIiwge1xuICAgICAgcm9sZTogbGFtYmRhUm9sZSxcbiAgICAgIHJ1bnRpbWU6IGF3c19sYW1iZGEuUnVudGltZS5OT0RFSlNfMThfWCxcbiAgICAgIGVudHJ5OiBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uLy4uL2xpYi9oYW5kbGVycy9pbmRleC50c1wiKSxcbiAgICAgIGhhbmRsZXI6IFwicXVvdGVIYW5kbGVyXCIsXG4gICAgICAvLyAxMS84LzIzOiBVUkEgY3VycmVudGx5IGNhbGxzIHRoZSBSb3V0aW5nIEFQSSB3aXRoIGEgdGltZW91dCBvZiAxMCBzZWNvbmRzLlxuICAgICAgLy8gU2V0IHRoaXMgbGFtYmRhJ3MgdGltZW91dCB0byBiZSBzbGlnaHRseSBsb3dlciB0byBnaXZlIHRoZW0gdGltZSB0b1xuICAgICAgLy8gbG9nIHRoZSByZXNwb25zZSBpbiB0aGUgZXZlbnQgb2YgYSBmYWlsdXJlIG9uIG91ciBlbmQuXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcyg5KSxcbiAgICAgIG1lbW9yeVNpemU6IDE3OTIsXG4gICAgICBlcGhlbWVyYWxTdG9yYWdlU2l6ZTogU2l6ZS5naWJpYnl0ZXMoMSksXG4gICAgICBkZWFkTGV0dGVyUXVldWVFbmFibGVkOiB0cnVlLFxuICAgICAgYnVuZGxpbmc6IHtcbiAgICAgICAgbWluaWZ5OiB0cnVlLFxuICAgICAgICBzb3VyY2VNYXA6IHRydWUsXG4gICAgICB9LFxuXG4gICAgICBhd3NTZGtDb25uZWN0aW9uUmV1c2U6IHRydWUsXG5cbiAgICAgIGRlc2NyaXB0aW9uOiBcIlJvdXRpbmcgTGFtYmRhXCIsXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBWRVJTSU9OOiBcIjZcIixcbiAgICAgICAgTk9ERV9PUFRJT05TOiBcIi0tZW5hYmxlLXNvdXJjZS1tYXBzXCIsXG4gICAgICAgIFBPT0xfQ0FDSEVfQlVDS0VUOiBwb29sQ2FjaGVCdWNrZXQuYnVja2V0TmFtZSxcbiAgICAgICAgUE9PTF9DQUNIRV9CVUNLRVRfMjogcG9vbENhY2hlQnVja2V0Mi5idWNrZXROYW1lLFxuICAgICAgICBQT09MX0NBQ0hFX0tFWTogcG9vbENhY2hlS2V5LFxuICAgICAgICBUT0tFTl9MSVNUX0NBQ0hFX0JVQ0tFVDogdG9rZW5MaXN0Q2FjaGVCdWNrZXQuYnVja2V0TmFtZSxcbiAgICAgICAgRVRIX0dBU19TVEFUSU9OX0lORk9fVVJMOiBldGhHYXNTdGF0aW9uSW5mb1VybCxcbiAgICAgICAgVEVOREVSTFlfVVNFUjogdGVuZGVybHlVc2VyLFxuICAgICAgICBURU5ERVJMWV9QUk9KRUNUOiB0ZW5kZXJseVByb2plY3QsXG4gICAgICAgIFRFTkRFUkxZX0FDQ0VTU19LRVk6IHRlbmRlcmx5QWNjZXNzS2V5LFxuICAgICAgICAvLyBXQVJOSU5HOiBEeW5hbW8gdGFibGUgbmFtZSBzaG91bGQgYmUgdGhlIHRhYmxlaW5zdGFuY2UubmFtZSwgZS5nLiByb3V0ZXNEeW5hbW9EYi50YWJsZU5hbWUuXG4gICAgICAgIC8vICAgICAgICAgIEJ1dCB3ZSB0cmllZCBhbmQgaGFkIHNlZW4gbGFtYmQgdmVyc2lvbiBlcnJvcjpcbiAgICAgICAgLy8gICAgICAgICAgVGhlIGZvbGxvd2luZyByZXNvdXJjZShzKSBmYWlsZWQgdG8gY3JlYXRlOiBbUm91dGluZ0xhbWJkYTJDdXJyZW50VmVyc2lvbjQ5QTFCQjk0ODM4OWNlNGY5YzI2YjE1ZTJjY2IwN2I0YzFiYWI3MjZdLlxuICAgICAgICAvLyAgICAgICAgICAyMDIzLTA5LTAxIDEwOjIyOjQzIFVUQy0wNzAwUm91dGluZ0xhbWJkYTJDdXJyZW50VmVyc2lvbjQ5QTFCQjk0ODM4OWNlNGY5YzI2YjE1ZTJjY2IwN2I0YzFiYWI3MjZDUkVBVEVfRkFJTEVEXG4gICAgICAgIC8vICAgICAgICAgIEEgdmVyc2lvbiBmb3IgdGhpcyBMYW1iZGEgZnVuY3Rpb24gZXhpc3RzICggMjYxICkuIE1vZGlmeSB0aGUgZnVuY3Rpb24gdG8gY3JlYXRlIGEgbmV3IHZlcnNpb24uXG4gICAgICAgIC8vICAgICAgICAgIEhlbmNlIHdlIGRvIG5vdCB3YW50IHRvIG1vZGlmeSB0aGUgdGFibGUgbmFtZSBiZWxvdy5cbiAgICAgICAgUk9VVEVTX1RBQkxFX05BTUU6IER5bmFtb0RCVGFibGVQcm9wcy5Sb3V0ZXNEYlRhYmxlLk5hbWUsXG4gICAgICAgIFJPVVRFU19DQUNISU5HX1JFUVVFU1RfRkxBR19UQUJMRV9OQU1FOiBEeW5hbW9EQlRhYmxlUHJvcHMuUm91dGVzRGJDYWNoaW5nUmVxdWVzdEZsYWdUYWJsZS5OYW1lLFxuICAgICAgICBDQUNIRURfUk9VVEVTX1RBQkxFX05BTUU6IER5bmFtb0RCVGFibGVQcm9wcy5DYWNoZVJvdXRlRHluYW1vRGJUYWJsZS5OYW1lLFxuICAgICAgICBDQUNISU5HX1JFUVVFU1RfRkxBR19UQUJMRV9OQU1FOiBEeW5hbW9EQlRhYmxlUHJvcHMuQ2FjaGluZ1JlcXVlc3RGbGFnRHluYW1vRGJUYWJsZS5OYW1lLFxuICAgICAgICBDQUNIRURfVjNfUE9PTFNfVEFCTEVfTkFNRTogRHluYW1vREJUYWJsZVByb3BzLlYzUG9vbHNEeW5hbW9EYlRhYmxlLk5hbWUsXG5cbiAgICAgICAgLy8gdG9rZW5Qcm9wZXJ0aWVzQ2FjaGluZ0R5bmFtb0RiLnRhYmxlTmFtZSBpcyB0aGUgY29ycmVjdCBmb3JtYXQuXG4gICAgICAgIC8vIHdlIHdpbGwgc3RhcnQgdXNpbmcgdGhlIGNvcnJlY3Qgb25lcyBnb2luZyBmb3J3YXJkXG4gICAgICAgIFRPS0VOX1BST1BFUlRJRVNfQ0FDSElOR19UQUJMRV9OQU1FOiB0b2tlblByb3BlcnRpZXNDYWNoaW5nRHluYW1vRGIudGFibGVOYW1lLFxuICAgICAgICBVTklDT1JOX1NFQ1JFVDogdW5pY29yblNlY3JldCxcbiAgICAgICAgLi4uanNvblJwY1Byb3ZpZGVycyxcbiAgICAgIH0sXG4gICAgICBsYXllcnM6IFtcbiAgICAgICAgYXdzX2xhbWJkYS5MYXllclZlcnNpb24uZnJvbUxheWVyVmVyc2lvbkFybihcbiAgICAgICAgICB0aGlzLFxuICAgICAgICAgIFwiSW5zaWdodHNMYXllclwiLFxuICAgICAgICAgIGBhcm46YXdzOmxhbWJkYToke3JlZ2lvbn06NTgwMjQ3Mjc1NDM1OmxheWVyOkxhbWJkYUluc2lnaHRzRXh0ZW5zaW9uOjE0YFxuICAgICAgICApLFxuICAgICAgXSxcbiAgICAgIHRyYWNpbmc6IGF3c19sYW1iZGEuVHJhY2luZy5BQ1RJVkUsXG4gICAgICBsb2dSZXRlbnRpb246IFJldGVudGlvbkRheXMuVFdPX1dFRUtTLFxuICAgIH0pO1xuXG4gICAgY29uc3QgbGFtYmRhQWxhcm1FcnJvclJhdGUgPSBuZXcgYXdzX2Nsb3Vkd2F0Y2guQWxhcm0odGhpcywgXCJSb3V0aW5nQVBJLUxhbWJkYUVycm9yUmF0ZVwiLCB7XG4gICAgICBtZXRyaWM6IG5ldyBhd3NfY2xvdWR3YXRjaC5NYXRoRXhwcmVzc2lvbih7XG4gICAgICAgIGV4cHJlc3Npb246IFwiZXJyb3JzIC8gaW52b2NhdGlvbnNcIixcbiAgICAgICAgdXNpbmdNZXRyaWNzOiB7XG4gICAgICAgICAgZXJyb3JzOiB0aGlzLnJvdXRpbmdMYW1iZGEubWV0cmljRXJyb3JzKHtcbiAgICAgICAgICAgIHBlcmlvZDogRHVyYXRpb24ubWludXRlcyg1KSxcbiAgICAgICAgICAgIHN0YXRpc3RpYzogXCJhdmdcIixcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBpbnZvY2F0aW9uczogdGhpcy5yb3V0aW5nTGFtYmRhLm1ldHJpY0ludm9jYXRpb25zKHtcbiAgICAgICAgICAgIHBlcmlvZDogRHVyYXRpb24ubWludXRlcyg1KSxcbiAgICAgICAgICAgIHN0YXRpc3RpYzogXCJhdmdcIixcbiAgICAgICAgICB9KSxcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgICAgdGhyZXNob2xkOiAwLjA1LFxuICAgICAgZXZhbHVhdGlvblBlcmlvZHM6IDMsXG4gICAgfSk7XG5cbiAgICBjb25zdCBsYW1iZGFUaHJvdHRsZXNFcnJvclJhdGUgPSBuZXcgYXdzX2Nsb3Vkd2F0Y2guQWxhcm0odGhpcywgXCJSb3V0aW5nQVBJLUxhbWJkYVRocm90dGxlc1wiLCB7XG4gICAgICBtZXRyaWM6IHRoaXMucm91dGluZ0xhbWJkYS5tZXRyaWNUaHJvdHRsZXMoe1xuICAgICAgICBwZXJpb2Q6IER1cmF0aW9uLm1pbnV0ZXMoNSksXG4gICAgICAgIHN0YXRpc3RpYzogXCJzdW1cIixcbiAgICAgIH0pLFxuICAgICAgdGhyZXNob2xkOiAxMCxcbiAgICAgIGV2YWx1YXRpb25QZXJpb2RzOiAzLFxuICAgIH0pO1xuXG4gICAgaWYgKGNoYXRib3RTTlNBcm4pIHtcbiAgICAgIGNvbnN0IGNoYXRCb3RUb3BpYyA9IGF3c19zbnMuVG9waWMuZnJvbVRvcGljQXJuKHRoaXMsIFwiQ2hhdGJvdFRvcGljXCIsIGNoYXRib3RTTlNBcm4pO1xuXG4gICAgICBsYW1iZGFBbGFybUVycm9yUmF0ZS5hZGRBbGFybUFjdGlvbihuZXcgYXdzX2Nsb3Vkd2F0Y2hfYWN0aW9ucy5TbnNBY3Rpb24oY2hhdEJvdFRvcGljKSk7XG5cbiAgICAgIGxhbWJkYVRocm90dGxlc0Vycm9yUmF0ZS5hZGRBbGFybUFjdGlvbihuZXcgYXdzX2Nsb3Vkd2F0Y2hfYWN0aW9ucy5TbnNBY3Rpb24oY2hhdEJvdFRvcGljKSk7XG4gICAgfVxuXG4gICAgY29uc3QgZW5hYmxlUHJvdmlzaW9uZWRDb25jdXJyZW5jeSA9IHByb3Zpc2lvbmVkQ29uY3VycmVuY3kgPiAwO1xuXG4gICAgdGhpcy5yb3V0aW5nTGFtYmRhQWxpYXMgPSBuZXcgYXdzX2xhbWJkYS5BbGlhcyh0aGlzLCBcIlJvdXRpbmdMaXZlQWxpYXNcIiwge1xuICAgICAgYWxpYXNOYW1lOiBcImxpdmVcIixcbiAgICAgIHZlcnNpb246IHRoaXMucm91dGluZ0xhbWJkYS5jdXJyZW50VmVyc2lvbixcbiAgICAgIHByb3Zpc2lvbmVkQ29uY3VycmVudEV4ZWN1dGlvbnM6IGVuYWJsZVByb3Zpc2lvbmVkQ29uY3VycmVuY3kgPyBwcm92aXNpb25lZENvbmN1cnJlbmN5IDogdW5kZWZpbmVkLFxuICAgIH0pO1xuXG4gICAgaWYgKGVuYWJsZVByb3Zpc2lvbmVkQ29uY3VycmVuY3kpIHtcbiAgICAgIGNvbnN0IHRhcmdldCA9IG5ldyBhc2cuU2NhbGFibGVUYXJnZXQodGhpcywgXCJSb3V0aW5nUHJvdkNvbmNBU0dcIiwge1xuICAgICAgICBzZXJ2aWNlTmFtZXNwYWNlOiBhc2cuU2VydmljZU5hbWVzcGFjZS5MQU1CREEsXG4gICAgICAgIG1heENhcGFjaXR5OiBwcm92aXNpb25lZENvbmN1cnJlbmN5ICogNSxcbiAgICAgICAgbWluQ2FwYWNpdHk6IHByb3Zpc2lvbmVkQ29uY3VycmVuY3ksXG4gICAgICAgIHJlc291cmNlSWQ6IGBmdW5jdGlvbjoke3RoaXMucm91dGluZ0xhbWJkYUFsaWFzLmxhbWJkYS5mdW5jdGlvbk5hbWV9OiR7dGhpcy5yb3V0aW5nTGFtYmRhQWxpYXMuYWxpYXNOYW1lfWAsXG4gICAgICAgIHNjYWxhYmxlRGltZW5zaW9uOiBcImxhbWJkYTpmdW5jdGlvbjpQcm92aXNpb25lZENvbmN1cnJlbmN5XCIsXG4gICAgICB9KTtcblxuICAgICAgdGFyZ2V0Lm5vZGUuYWRkRGVwZW5kZW5jeSh0aGlzLnJvdXRpbmdMYW1iZGFBbGlhcyk7XG5cbiAgICAgIHRhcmdldC5zY2FsZVRvVHJhY2tNZXRyaWMoXCJSb3V0aW5nUHJvdkNvbmNUcmFja2luZ1wiLCB7XG4gICAgICAgIHRhcmdldFZhbHVlOiAwLjgsXG4gICAgICAgIHByZWRlZmluZWRNZXRyaWM6IGFzZy5QcmVkZWZpbmVkTWV0cmljLkxBTUJEQV9QUk9WSVNJT05FRF9DT05DVVJSRU5DWV9VVElMSVpBVElPTixcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufVxuIl19