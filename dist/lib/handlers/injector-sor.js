import { CachingGasStationProvider, CachingTokenListProvider, CachingTokenProviderWithFallback, CachingV3PoolProvider, EIP1559GasPriceProvider, FallbackTenderlySimulator, TenderlySimulator, EthEstimateGasSimulator, LegacyGasPriceProvider, NodeJSCache, OnChainGasPriceProvider, OnChainQuoteProvider, setGlobalLogger, StaticV3SubgraphProvider, TokenProvider, TokenPropertiesProvider, UniswapMulticallProvider, V3PoolProvider, TokenValidatorProvider, } from "@votopia/smart-order-router";
import { default as bunyan } from "bunyan";
import _ from "lodash";
import NodeCache from "node-cache";
import UNSUPPORTED_TOKEN_LIST from "./../config/unsupported.tokenlist.json";
import { Injector } from "./handler";
import { V3AWSSubgraphProvider } from "./router-entities/aws-subgraph-provider";
import { AWSTokenListProvider } from "./router-entities/aws-token-list-provider";
import { DynamoRouteCachingProvider } from "./router-entities/route-caching/dynamo-route-caching-provider";
import { DynamoDBCachingV3PoolProvider } from "./pools/pool-caching/v3/dynamo-caching-pool-provider";
import { TrafficSwitchV3PoolProvider } from "./pools/provider-migration/v3/traffic-switch-v3-pool-provider";
import { DefaultEVMClient } from "./evm/EVMClient";
import { InstrumentedEVMProvider } from "./evm/provider/InstrumentedEVMProvider";
import { deriveProviderName } from "./evm/provider/ProviderName";
import { OnChainTokenFeeFetcher } from "@votopia/smart-order-router/build/main/providers/token-fee-fetcher";
const DEFAULT_TOKEN_LIST = "https://gateway.ipfs.io/ipns/tokens.uniswap.org";
export var ChainId;
(function (ChainId) {
    ChainId[ChainId["OPTOPIA"] = 62050] = "OPTOPIA";
})(ChainId || (ChainId = {}));
export const SUPPORTED_CHAINS = [ChainId.OPTOPIA];
export class InjectorSOR extends Injector {
    async buildContainerInjected() {
        const log = bunyan.createLogger({
            name: this.injectorName,
            serializers: bunyan.stdSerializers,
            level: bunyan.INFO,
        });
        setGlobalLogger(log);
        try {
            const { POOL_CACHE_BUCKET_2, POOL_CACHE_KEY, TOKEN_LIST_CACHE_BUCKET, ROUTES_TABLE_NAME, ROUTES_CACHING_REQUEST_FLAG_TABLE_NAME, CACHED_ROUTES_TABLE_NAME, AWS_LAMBDA_FUNCTION_NAME, } = process.env;
            const dependenciesByChain = {};
            const dependenciesByChainArray = await Promise.all(_.map(SUPPORTED_CHAINS, async (chainId) => {
                const url = process.env[`WEB3_RPC_${chainId.toString()}`];
                if (!url) {
                    log.fatal({ chainId: chainId }, `Fatal: No Web3 RPC endpoint set for chain`);
                    return { chainId, dependencies: {} };
                    // This router instance will not be able to route through any chain
                    // for which RPC URL is not set
                    // For now, if RPC URL is not set for a chain, a request to route
                    // on the chain will return Err 500
                }
                let timeout;
                switch (chainId) {
                    default:
                        timeout = 5000;
                        break;
                }
                const provider = new DefaultEVMClient({
                    allProviders: [
                        new InstrumentedEVMProvider({
                            url: {
                                url: url,
                                timeout,
                            },
                            network: chainId,
                            name: deriveProviderName(url),
                        }),
                    ],
                }).getProvider();
                const tokenCache = new NodeJSCache(new NodeCache({ stdTTL: 3600, useClones: false }));
                const blockedTokenCache = new NodeJSCache(new NodeCache({ stdTTL: 3600, useClones: false }));
                const multicall2Provider = new UniswapMulticallProvider(provider, 375000);
                const noCacheV3PoolProvider = new V3PoolProvider(multicall2Provider);
                const inMemoryCachingV3PoolProvider = new CachingV3PoolProvider(noCacheV3PoolProvider, new NodeJSCache(new NodeCache({ stdTTL: 180, useClones: false })));
                const dynamoCachingV3PoolProvider = new DynamoDBCachingV3PoolProvider(noCacheV3PoolProvider, "V3PoolsCachingDB");
                const v3PoolProvider = new TrafficSwitchV3PoolProvider({
                    currentPoolProvider: inMemoryCachingV3PoolProvider,
                    targetPoolProvider: dynamoCachingV3PoolProvider,
                    sourceOfTruthPoolProvider: noCacheV3PoolProvider,
                });
                const tokenFeeFetcher = new OnChainTokenFeeFetcher(provider);
                const tokenValidatorProvider = new TokenValidatorProvider(multicall2Provider, new NodeJSCache(new NodeCache({ stdTTL: 30000, useClones: false })));
                const tokenPropertiesProvider = new TokenPropertiesProvider(new NodeJSCache(new NodeCache({ stdTTL: 30000, useClones: false })), tokenFeeFetcher);
                const [tokenListProvider, blockedTokenListProvider, v3SubgraphProvider] = await Promise.all([
                    AWSTokenListProvider.fromTokenListS3Bucket(TOKEN_LIST_CACHE_BUCKET, DEFAULT_TOKEN_LIST),
                    CachingTokenListProvider.fromTokenList(UNSUPPORTED_TOKEN_LIST, blockedTokenCache),
                    (async () => {
                        try {
                            const subgraphProvider = await V3AWSSubgraphProvider.EagerBuild(POOL_CACHE_BUCKET_2, POOL_CACHE_KEY);
                            return subgraphProvider;
                        }
                        catch (err) {
                            log.error({ err }, "AWS Subgraph Provider unavailable, defaulting to Static Subgraph Provider");
                            return new StaticV3SubgraphProvider(v3PoolProvider);
                        }
                    })(),
                ]);
                const tokenProvider = new CachingTokenProviderWithFallback(tokenCache, tokenListProvider, new TokenProvider(multicall2Provider));
                // Some providers like Infura set a gas limit per call of 10x block gas which is approx 150m
                // 200*725k < 150m
                let quoteProvider = undefined;
                switch (chainId) {
                    case ChainId.OPTOPIA:
                        quoteProvider = new OnChainQuoteProvider(provider, multicall2Provider, {
                            retries: 2,
                            minTimeout: 100,
                            maxTimeout: 1000,
                        }, {
                            multicallChunk: 110,
                            gasLimitPerCall: 1200000,
                            quoteMinSuccessRate: 0.1,
                        }, {
                            gasLimitOverride: 3000000,
                            multicallChunk: 45,
                        }, {
                            gasLimitOverride: 3000000,
                            multicallChunk: 45,
                        }, {
                            baseBlockOffset: -25,
                            rollback: {
                                enabled: true,
                                attemptsBeforeRollback: 1,
                                rollbackBlockOffset: -20,
                            },
                        });
                        break;
                }
                const tenderlySimulator = new TenderlySimulator("https://api.tenderly.co", process.env.TENDERLY_USER, process.env.TENDERLY_PROJECT, process.env.TENDERLY_ACCESS_KEY, v3PoolProvider, provider, undefined, 
                // The timeout for the underlying axios call to Tenderly, measured in milliseconds.
                5 * 1000);
                const ethEstimateGasSimulator = new EthEstimateGasSimulator(provider, v3PoolProvider);
                const simulator = new FallbackTenderlySimulator(provider, tenderlySimulator, ethEstimateGasSimulator);
                let routeCachingProvider = undefined;
                if (CACHED_ROUTES_TABLE_NAME && CACHED_ROUTES_TABLE_NAME !== "") {
                    routeCachingProvider = new DynamoRouteCachingProvider({
                        routesTableName: ROUTES_TABLE_NAME,
                        routesCachingRequestFlagTableName: ROUTES_CACHING_REQUEST_FLAG_TABLE_NAME,
                        cachingQuoteLambdaName: AWS_LAMBDA_FUNCTION_NAME,
                    });
                }
                return {
                    chainId,
                    dependencies: {
                        provider,
                        tokenListProvider,
                        blockedTokenListProvider,
                        multicallProvider: multicall2Provider,
                        tokenProvider,
                        tokenProviderFromTokenList: tokenListProvider,
                        gasPriceProvider: new CachingGasStationProvider(new OnChainGasPriceProvider(new EIP1559GasPriceProvider(provider), new LegacyGasPriceProvider(provider)), new NodeJSCache(new NodeCache({ stdTTL: 15, useClones: false }))),
                        v3SubgraphProvider,
                        onChainQuoteProvider: quoteProvider,
                        v3PoolProvider,
                        simulator,
                        routeCachingProvider,
                        tokenValidatorProvider,
                        tokenPropertiesProvider,
                    },
                };
            }));
            for (const { chainId, dependencies } of dependenciesByChainArray) {
                dependenciesByChain[chainId] = dependencies;
            }
            return {
                dependencies: dependenciesByChain,
            };
        }
        catch (err) {
            log.fatal({ err }, `Fatal: Failed to build container`);
            throw err;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5qZWN0b3Itc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL2hhbmRsZXJzL2luamVjdG9yLXNvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQ0wseUJBQXlCLEVBQ3pCLHdCQUF3QixFQUN4QixnQ0FBZ0MsRUFDaEMscUJBQXFCLEVBQ3JCLHVCQUF1QixFQUN2Qix5QkFBeUIsRUFDekIsaUJBQWlCLEVBQ2pCLHVCQUF1QixFQVF2QixzQkFBc0IsRUFDdEIsV0FBVyxFQUNYLHVCQUF1QixFQUN2QixvQkFBb0IsRUFDcEIsZUFBZSxFQUNmLHdCQUF3QixFQUN4QixhQUFhLEVBQ2IsdUJBQXVCLEVBQ3ZCLHdCQUF3QixFQUN4QixjQUFjLEVBRWQsc0JBQXNCLEdBRXZCLE1BQU0sNkJBQTZCLENBQUM7QUFFckMsT0FBTyxFQUFFLE9BQU8sSUFBSSxNQUFNLEVBQXFCLE1BQU0sUUFBUSxDQUFDO0FBRTlELE9BQU8sQ0FBQyxNQUFNLFFBQVEsQ0FBQztBQUN2QixPQUFPLFNBQVMsTUFBTSxZQUFZLENBQUM7QUFDbkMsT0FBTyxzQkFBc0IsTUFBTSx3Q0FBd0MsQ0FBQztBQUM1RSxPQUFPLEVBQVksUUFBUSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQy9DLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBQ2hGLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDJDQUEyQyxDQUFDO0FBQ2pGLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLCtEQUErRCxDQUFDO0FBQzNHLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxNQUFNLHNEQUFzRCxDQUFDO0FBQ3JHLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLCtEQUErRCxDQUFDO0FBQzVHLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ25ELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLHdDQUF3QyxDQUFD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c0IsQ0FBQyxRQUFRLENBQUMsQ0FDckMsRUFDRCxJQUFJLFdBQVcsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FDakU7d0JBQ0Qsa0JBQWtCO3dCQUNsQixvQkFBb0IsRUFBRSxhQUFhO3dCQUNuQyxjQUFjO3dCQUNkLFNBQVM7d0JBQ1Qsb0JBQW9CO3dCQUNwQixzQkFBc0I7d0JBQ3RCLHVCQUF1QjtxQkFDeEI7aUJBQ0YsQ0FBQztZQUNKLENBQUMsQ0FBQyxDQUNILENBQUM7WUFFRixLQUFLLE1BQU0sRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLElBQUksd0JBQXdCLEVBQUU7Z0JBQy9ELG1CQUEyQixDQUFDLE9BQU8sQ0FBQyxHQUFHLFlBQVksQ0FBQzthQUN0RDtZQUVELE9BQU87Z0JBQ0wsWUFBWSxFQUFFLG1CQUFtQjthQUNsQyxDQUFDO1NBQ0g7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNaLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxHQUFHLEVBQUUsRUFBRSxrQ0FBa0MsQ0FBQyxDQUFDO1lBQ3ZELE1BQU0sR0FBRyxDQUFDO1NBQ1g7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUb2tlbiwgVG9rZW5MaXN0IH0gZnJvbSBcIkB2b3RvcGlhL3Nkay1jb3JlXCI7XG5pbXBvcnQge1xuICBDYWNoaW5nR2FzU3RhdGlvblByb3ZpZGVyLFxuICBDYWNoaW5nVG9rZW5MaXN0UHJvdmlkZXIsXG4gIENhY2hpbmdUb2tlblByb3ZpZGVyV2l0aEZhbGxiYWNrLFxuICBDYWNoaW5nVjNQb29sUHJvdmlkZXIsXG4gIEVJUDE1NTlHYXNQcmljZVByb3ZpZGVyLFxuICBGYWxsYmFja1RlbmRlcmx5U2ltdWxhdG9yLFxuICBUZW5kZXJseVNpbXVsYXRvcixcbiAgRXRoRXN0aW1hdGVHYXNTaW11bGF0b3IsXG4gIElHYXNQcmljZVByb3ZpZGVyLFxuICBJTWV0cmljLFxuICBTaW11bGF0b3IsXG4gIElUb2tlbkxpc3RQcm92aWRlcixcbiAgSVRva2VuUHJvdmlkZXIsXG4gIElWM1Bvb2xQcm92aWRlcixcbiAgSVYzU3ViZ3JhcGhQcm92aWRlcixcbiAgTGVnYWN5R2FzUHJpY2VQcm92aWRlcixcbiAgTm9kZUpTQ2FjaGUsXG4gIE9uQ2hhaW5HYXNQcmljZVByb3ZpZGVyLFxuICBPbkNoYWluUXVvdGVQcm92aWRlcixcbiAgc2V0R2xvYmFsTG9nZ2VyLFxuICBTdGF0aWNWM1N1YmdyYXBoUHJvdmlkZXIsXG4gIFRva2VuUHJvdmlkZXIsXG4gIFRva2VuUHJvcGVydGllc1Byb3ZpZGVyLFxuICBVbmlzd2FwTXVsdGljYWxsUHJvdmlkZXIsXG4gIFYzUG9vbFByb3ZpZGVyLFxuICBJUm91dGVDYWNoaW5nUHJvdmlkZXIsXG4gIFRva2VuVmFsaWRhdG9yUHJvdmlkZXIsXG4gIElUb2tlblByb3BlcnRpZXNQcm92aWRlcixcbn0gZnJvbSBcIkB2b3RvcGlhL3NtYXJ0LW9yZGVyLXJvdXRlclwiO1xuXG5pbXBvcnQgeyBkZWZhdWx0IGFzIGJ1bnlhbiwgZGVmYXVsdCBhcyBMb2dnZXIgfSBmcm9tIFwiYnVueWFuXCI7XG5pbXBvcnQgeyBldGhlcnMgfSBmcm9tIFwiZXRoZXJzXCI7XG5pbXBvcnQgXyBmcm9tIFwibG9kYXNoXCI7XG5pbXBvcnQgTm9kZUNhY2hlIGZyb20gXCJub2RlLWNhY2hlXCI7XG5pbXBvcnQgVU5TVVBQT1JURURfVE9LRU5fTElTVCBmcm9tIFwiLi8uLi9jb25maWcvdW5zdXBwb3J0ZWQudG9rZW5saXN0Lmpzb25cIjtcbmltcG9ydCB7IEJhc2VSSW5qLCBJbmplY3RvciB9IGZyb20gXCIuL2hhbmRsZXJcIjtcbmltcG9ydCB7IFYzQVdTU3ViZ3JhcGhQcm92aWRlciB9IGZyb20gXCIuL3JvdXRlci1lbnRpdGllcy9hd3Mtc3ViZ3JhcGgtcHJvdmlkZXJcIjtcbmltcG9ydCB7IEFXU1Rva2VuTGlzdFByb3ZpZGVyIH0gZnJvbSBcIi4vcm91dGVyLWVudGl0aWVzL2F3cy10b2tlbi1saXN0LXByb3ZpZGVyXCI7XG5pbXBvcnQgeyBEeW5hbW9Sb3V0ZUNhY2hpbmdQcm92aWRlciB9IGZyb20gXCIuL3JvdXRlci1lbnRpdGllcy9yb3V0ZS1jYWNoaW5nL2R5bmFtby1yb3V0ZS1jYWNoaW5nLXByb3ZpZGVyXCI7XG5pbXBvcnQgeyBEeW5hbW9EQkNhY2hpbmdWM1Bvb2xQcm92aWRlciB9IGZyb20gXCIuL3Bvb2xzL3Bvb2wtY2FjaGluZy92My9keW5hbW8tY2FjaGluZy1wb29sLXByb3ZpZGVyXCI7XG5pbXBvcnQgeyBUcmFmZmljU3dpdGNoVjNQb29sUHJvdmlkZXIgfSBmcm9tIFwiLi9wb29scy9wcm92aWRlci1taWdyYXRpb24vdjMvdHJhZmZpYy1zd2l0Y2gtdjMtcG9vbC1wcm92aWRlclwiO1xuaW1wb3J0IHsgRGVmYXVsdEVWTUNsaWVudCB9IGZyb20gXCIuL2V2bS9FVk1DbGllbnRcIjtcbmltcG9ydCB7IEluc3RydW1lbnRlZEVWTVByb3ZpZGVyIH0gZnJvbSBcIi4vZXZtL3Byb3ZpZGVyL0luc3RydW1lbnRlZEVWTVByb3ZpZGVyXCI7XG5pbXBvcnQgeyBkZXJpdmVQcm92aWRlck5hbWUgfSBmcm9tIFwiLi9ldm0vcHJvdmlkZXIvUHJvdmlkZXJOYW1lXCI7XG5cbmltcG9ydCB7IE9uQ2hhaW5Ub2tlbkZlZUZldGNoZXIgfSBmcm9tIFwiQHZvdG9waWEvc21hcnQtb3JkZXItcm91dGVyL2J1aWxkL21haW4vcHJvdmlkZXJzL3Rva2VuLWZlZS1mZXRjaGVyXCI7XG5cbmNvbnN0IERFRkFVTFRfVE9LRU5fTElTVCA9IFwiaHR0cHM6Ly9nYXRld2F5LmlwZnMuaW8vaXBucy90b2tlbnMudW5pc3dhcC5vcmdcIjtcblxuZXhwb3J0IGVudW0gQ2hhaW5JZCB7XG4gIE9QVE9QSUEgPSA2MjA1MCxcbn1cblxuZXhwb3J0IGNvbnN0IFNVUFBPUlRFRF9DSEFJTlMgPSBbQ2hhaW5JZC5PUFRPUElBXTtcblxuZXhwb3J0IGludGVyZmFjZSBSZXF1ZXN0SW5qZWN0ZWQ8Um91dGVyPiBleHRlbmRzIEJhc2VSSW5qIHtcbiAgbWV0cmljOiBJTWV0cmljO1xuICB2M1Bvb2xQcm92aWRlcjogSVYzUG9vbFByb3ZpZGVyO1xuXG4gIHRva2VuUHJvdmlkZXI6IElUb2tlblByb3ZpZGVyO1xuICB0b2tlbkxpc3RQcm92aWRlcjogSVRva2VuTGlzdFByb3ZpZGVyO1xuICByb3V0ZXI6IFJvdXRlcjtcbiAgcXVvdGVTcGVlZD86IHN0cmluZztcbiAgaW50ZW50Pzogc3RyaW5nO1xufVxuXG5leHBvcnQgdHlwZSBDb250YWluZXJEZXBlbmRlbmNpZXMgPSB7XG4gIHByb3ZpZGVyOiBldGhlcnMucHJvdmlkZXJzLlN0YXRpY0pzb25ScGNQcm92aWRlcjtcbiAgdjNTdWJncmFwaFByb3ZpZGVyOiBJVjNTdWJncmFwaFByb3ZpZGVyO1xuXG4gIHRva2VuTGlzdFByb3ZpZGVyOiBJVG9rZW5MaXN0UHJvdmlkZXI7XG4gIGdhc1ByaWNlUHJvdmlkZXI6IElHYXNQcmljZVByb3ZpZGVyO1xuICB0b2tlblByb3ZpZGVyRnJvbVRva2VuTGlzdDogSVRva2VuUHJvdmlkZXI7XG4gIGJsb2NrZWRUb2tlbkxpc3RQcm92aWRlcjogSVRva2VuTGlzdFByb3ZpZGVyO1xuICB2M1Bvb2xQcm92aWRlcjogSVYzUG9vbFByb3ZpZGVyO1xuXG4gIHRva2VuUHJvdmlkZXI6IElUb2tlblByb3ZpZGVyO1xuICBtdWx0aWNhbGxQcm92aWRlcjogVW5pc3dhcE11bHRpY2FsbFByb3ZpZGVyO1xuICBvbkNoYWluUXVvdGVQcm92aWRlcj86IE9uQ2hhaW5RdW90ZVByb3ZpZGVyO1xuXG4gIHNpbXVsYXRvcjogU2ltdWxhdG9yO1xuICByb3V0ZUNhY2hpbmdQcm92aWRlcj86IElSb3V0ZUNhY2hpbmdQcm92aWRlcjtcbiAgdG9rZW5WYWxpZGF0b3JQcm92aWRlcjogVG9rZW5WYWxpZGF0b3JQcm92aWRlcjtcbiAgdG9rZW5Qcm9wZXJ0aWVzUHJvdmlkZXI6IElUb2tlblByb3BlcnRpZXNQcm92aWRlcjtcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29udGFpbmVySW5qZWN0ZWQge1xuICBkZXBlbmRlbmNpZXM6IHtcbiAgICBbY2hhaW5JZCBpbiBDaGFpbklkXT86IENvbnRhaW5lckRlcGVuZGVuY2llcztcbiAgfTtcbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEluamVjdG9yU09SPFJvdXRlciwgUXVlcnlQYXJhbXM+IGV4dGVuZHMgSW5qZWN0b3I8XG4gIENvbnRhaW5lckluamVjdGVkLFxuICBSZXF1ZXN0SW5qZWN0ZWQ8Um91dGVyPixcbiAgdm9pZCxcbiAgUXVlcnlQYXJhbXNcbj4ge1xuICBwdWJsaWMgYXN5bmMgYnVpbGRDb250YWluZXJJbmplY3RlZCgpOiBQcm9taXNlPENvbnRhaW5lckluamVjdGVkPiB7XG4gICAgY29uc3QgbG9nOiBMb2dnZXIgPSBidW55YW4uY3JlYXRlTG9nZ2VyKHtcbiAgICAgIG5hbWU6IHRoaXMuaW5qZWN0b3JOYW1lLFxuICAgICAgc2VyaWFsaXplcnM6IGJ1bnlhbi5zdGRTZXJpYWxpemVycyxcbiAgICAgIGxldmVsOiBidW55YW4uSU5GTyxcbiAgICB9KTtcbiAgICBzZXRHbG9iYWxMb2dnZXIobG9nKTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCB7XG4gICAgICAgIFBPT0xfQ0FDSEVfQlVDS0VUXzIsXG4gICAgICAgIFBPT0xfQ0FDSEVfS0VZLFxuICAgICAgICBUT0tFTl9MSVNUX0NBQ0hFX0JVQ0tFVCxcbiAgICAgICAgUk9VVEVTX1RBQkxFX05BTUUsXG4gICAgICAgIFJPVVRFU19DQUNISU5HX1JFUVVFU1RfRkxBR19UQUJMRV9OQU1FLFxuICAgICAgICBDQUNIRURfUk9VVEVTX1RBQkxFX05BTUUsXG4gICAgICAgIEFXU19MQU1CREFfRlVOQ1RJT05fTkFNRSxcbiAgICAgIH0gPSBwcm9jZXNzLmVudjtcblxuICAgICAgY29uc3QgZGVwZW5kZW5jaWVzQnlDaGFpbjoge1xuICAgICAgICBbY2hhaW5JZCBpbiBDaGFpbklkXT86IENvbnRhaW5lckRlcGVuZGVuY2llcztcbiAgICAgIH0gPSB7fTtcblxuICAgICAgY29uc3QgZGVwZW5kZW5jaWVzQnlDaGFpbkFycmF5ID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgIF8ubWFwKFNVUFBPUlRFRF9DSEFJTlMsIGFzeW5jIChjaGFpbklkKSA9PiB7XG4gICAgICAgICAgY29uc3QgdXJsID0gcHJvY2Vzcy5lbnZbYFdFQjNfUlBDXyR7Y2hhaW5JZC50b1N0cmluZygpfWBdITtcbiAgICAgICAgICBpZiAoIXVybCkge1xuICAgICAgICAgICAgbG9nLmZhdGFsKHsgY2hhaW5JZDogY2hhaW5JZCB9LCBgRmF0YWw6IE5vIFdlYjMgUlBDIGVuZHBvaW50IHNldCBmb3IgY2hhaW5gKTtcbiAgICAgICAgICAgIHJldHVybiB7IGNoYWluSWQsIGRlcGVuZGVuY2llczoge30gYXMgQ29udGFpbmVyRGVwZW5kZW5jaWVzIH07XG4gICAgICAgICAgICAvLyBUaGlzIHJvdXRlciBpbnN0YW5jZSB3aWxsIG5vdCBiZSBhYmxlIHRvIHJvdXRlIHRocm91Z2ggYW55IGNoYWluXG4gICAgICAgICAgICAvLyBmb3Igd2hpY2ggUlBDIFVSTCBpcyBub3Qgc2V0XG4gICAgICAgICAgICAvLyBGb3Igbm93LCBpZiBSUEMgVVJMIGlzIG5vdCBzZXQgZm9yIGEgY2hhaW4sIGEgcmVxdWVzdCB0byByb3V0ZVxuICAgICAgICAgICAgLy8gb24gdGhlIGNoYWluIHdpbGwgcmV0dXJuIEVyciA1MDBcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBsZXQgdGltZW91dDogbnVtYmVyO1xuICAgICAgICAgIHN3aXRjaCAoY2hhaW5JZCkge1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgdGltZW91dCA9IDUwMDA7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IHByb3ZpZGVyID0gbmV3IERlZmF1bHRFVk1DbGllbnQoe1xuICAgICAgICAgICAgYWxsUHJvdmlkZXJzOiBbXG4gICAgICAgICAgICAgIG5ldyBJbnN0cnVtZW50ZWRFVk1Qcm92aWRlcih7XG4gICAgICAgICAgICAgICAgdXJsOiB7XG4gICAgICAgICAgICAgICAgICB1cmw6IHVybCxcbiAgICAgICAgICAgICAgICAgIHRpbWVvdXQsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBuZXR3b3JrOiBjaGFpbklkLFxuICAgICAgICAgICAgICAgIG5hbWU6IGRlcml2ZVByb3ZpZGVyTmFtZSh1cmwpLFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgfSkuZ2V0UHJvdmlkZXIoKTtcblxuICAgICAgICAgIGNvbnN0IHRva2VuQ2FjaGUgPSBuZXcgTm9kZUpTQ2FjaGU8VG9rZW4+KG5ldyBOb2RlQ2FjaGUoeyBzdGRUVEw6IDM2MDAsIHVzZUNsb25lczogZmFsc2UgfSkpO1xuICAgICAgICAgIGNvbnN0IGJsb2NrZWRUb2tlbkNhY2hlID0gbmV3IE5vZGVKU0NhY2hlPFRva2VuPihuZXcgTm9kZUNhY2hlKHsgc3RkVFRMOiAzNjAwLCB1c2VDbG9uZXM6IGZhbHNlIH0pKTtcbiAgICAgICAgICBjb25zdCBtdWx0aWNhbGwyUHJvdmlkZXIgPSBuZXcgVW5pc3dhcE11bHRpY2FsbFByb3ZpZGVyKHByb3ZpZGVyLCAzNzVfMDAwKTtcblxuICAgICAgICAgIGNvbnN0IG5vQ2FjaGVWM1Bvb2xQcm92aWRlciA9IG5ldyBWM1Bvb2xQcm92aWRlcihtdWx0aWNhbGwyUHJvdmlkZXIpO1xuICAgICAgICAgIGNvbnN0IGluTWVtb3J5Q2FjaGluZ1YzUG9vbFByb3ZpZGVyID0gbmV3IENhY2hpbmdWM1Bvb2xQcm92aWRlcihcbiAgICAgICAgICAgIG5vQ2FjaGVWM1Bvb2xQcm92aWRlcixcbiAgICAgICAgICAgIG5ldyBOb2RlSlNDYWNoZShuZXcgTm9kZUNhY2hlKHsgc3RkVFRMOiAxODAsIHVzZUNsb25lczogZmFsc2UgfSkpXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb25zdCBkeW5hbW9DYWNoaW5nVjNQb29sUHJvdmlkZXIgPSBuZXcgRHluYW1vREJDYWNoaW5nVjNQb29sUHJvdmlkZXIoXG4gICAgICAgICAgICBub0NhY2hlVjNQb29sUHJvdmlkZXIsXG4gICAgICAgICAgICBcIlYzUG9vbHNDYWNoaW5nREJcIlxuICAgICAgICAgICk7XG5cbiAgICAgICAgICBjb25zdCB2M1Bvb2xQcm92aWRlciA9IG5ldyBUcmFmZmljU3dpdGNoVjNQb29sUHJvdmlkZXIoe1xuICAgICAgICAgICAgY3VycmVudFBvb2xQcm92aWRlcjogaW5NZW1vcnlDYWNoaW5nVjNQb29sUHJvdmlkZXIsXG4gICAgICAgICAgICB0YXJnZXRQb29sUHJvdmlkZXI6IGR5bmFtb0NhY2hpbmdWM1Bvb2xQcm92aWRlcixcbiAgICAgICAgICAgIHNvdXJjZU9mVHJ1dGhQb29sUHJvdmlkZXI6IG5vQ2FjaGVWM1Bvb2xQcm92aWRlcixcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIGNvbnN0IHRva2VuRmVlRmV0Y2hlciA9IG5ldyBPbkNoYWluVG9rZW5GZWVGZXRjaGVyKHByb3ZpZGVyKTtcbiAgICAgICAgICBjb25zdCB0b2tlblZhbGlkYXRvclByb3ZpZGVyID0gbmV3IFRva2VuVmFsaWRhdG9yUHJvdmlkZXIoXG4gICAgICAgICAgICBtdWx0aWNhbGwyUHJvdmlkZXIsXG4gICAgICAgICAgICBuZXcgTm9kZUpTQ2FjaGUobmV3IE5vZGVDYWNoZSh7IHN0ZFRUTDogMzAwMDAsIHVzZUNsb25lczogZmFsc2UgfSkpXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb25zdCB0b2tlblByb3BlcnRpZXNQcm92aWRlciA9IG5ldyBUb2tlblByb3BlcnRpZXNQcm92aWRlcihcbiAgICAgICAgICAgIG5ldyBOb2RlSlNDYWNoZShuZXcgTm9kZUNhY2hlKHsgc3RkVFRMOiAzMDAwMCwgdXNlQ2xvbmVzOiBmYWxzZSB9KSksXG4gICAgICAgICAgICB0b2tlbkZlZUZldGNoZXJcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgY29uc3QgW3Rva2VuTGlzdFByb3ZpZGVyLCBibG9ja2VkVG9rZW5MaXN0UHJvdmlkZXIsIHYzU3ViZ3JhcGhQcm92aWRlcl0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICBBV1NUb2tlbkxpc3RQcm92aWRlci5mcm9tVG9rZW5MaXN0UzNCdWNrZXQoVE9LRU5fTElTVF9DQUNIRV9CVUNLRVQhLCBERUZBVUxUX1RPS0VOX0xJU1QpLFxuICAgICAgICAgICAgQ2FjaGluZ1Rva2VuTGlzdFByb3ZpZGVyLmZyb21Ub2tlbkxpc3QoVU5TVVBQT1JURURfVE9LRU5fTElTVCBhcyBUb2tlbkxpc3QsIGJsb2NrZWRUb2tlbkNhY2hlKSxcbiAgICAgICAgICAgIChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3ViZ3JhcGhQcm92aWRlciA9IGF3YWl0IFYzQVdTU3ViZ3JhcGhQcm92aWRlci5FYWdlckJ1aWxkKFBPT0xfQ0FDSEVfQlVDS0VUXzIhLCBQT09MX0NBQ0hFX0tFWSEpO1xuICAgICAgICAgICAgICAgIHJldHVybiBzdWJncmFwaFByb3ZpZGVyO1xuICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICBsb2cuZXJyb3IoeyBlcnIgfSwgXCJBV1MgU3ViZ3JhcGggUHJvdmlkZXIgdW5hdmFpbGFibGUsIGRlZmF1bHRpbmcgdG8gU3RhdGljIFN1YmdyYXBoIFByb3ZpZGVyXCIpO1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgU3RhdGljVjNTdWJncmFwaFByb3ZpZGVyKHYzUG9vbFByb3ZpZGVyKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSkoKSxcbiAgICAgICAgICBdKTtcblxuICAgICAgICAgIGNvbnN0IHRva2VuUHJvdmlkZXIgPSBuZXcgQ2FjaGluZ1Rva2VuUHJvdmlkZXJXaXRoRmFsbGJhY2soXG4gICAgICAgICAgICB0b2tlbkNhY2hlLFxuICAgICAgICAgICAgdG9rZW5MaXN0UHJvdmlkZXIsXG4gICAgICAgICAgICBuZXcgVG9rZW5Qcm92aWRlcihtdWx0aWNhbGwyUHJvdmlkZXIpXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIC8vIFNvbWUgcHJvdmlkZXJzIGxpa2UgSW5mdXJhIHNldCBhIGdhcyBsaW1pdCBwZXIgY2FsbCBvZiAxMHggYmxvY2sgZ2FzIHdoaWNoIGlzIGFwcHJveCAxNTBtXG4gICAgICAgICAgLy8gMjAwKjcyNWsgPCAxNTBtXG4gICAgICAgICAgbGV0IHF1b3RlUHJvdmlkZXI6IE9uQ2hhaW5RdW90ZVByb3ZpZGVyIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuICAgICAgICAgIHN3aXRjaCAoY2hhaW5JZCkge1xuICAgICAgICAgICAgY2FzZSBDaGFpbklkLk9QVE9QSUE6XG4gICAgICAgICAgICAgIHF1b3RlUHJvdmlkZXIgPSBuZXcgT25DaGFpblF1b3RlUHJvdmlkZXIoXG4gICAgICAgICAgICAgICAgcHJvdmlkZXIsXG4gICAgICAgICAgICAgICAgbXVsdGljYWxsMlByb3ZpZGVyLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIHJldHJpZXM6IDIsXG4gICAgICAgICAgICAgICAgICBtaW5UaW1lb3V0OiAxMDAsXG4gICAgICAgICAgICAgICAgICBtYXhUaW1lb3V0OiAxMDAwLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgbXVsdGljYWxsQ2h1bms6IDExMCxcbiAgICAgICAgICAgICAgICAgIGdhc0xpbWl0UGVyQ2FsbDogMV8yMDBfMDAwLFxuICAgICAgICAgICAgICAgICAgcXVvdGVNaW5TdWNjZXNzUmF0ZTogMC4xLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgZ2FzTGltaXRPdmVycmlkZTogM18wMDBfMDAwLFxuICAgICAgICAgICAgICAgICAgbXVsdGljYWxsQ2h1bms6IDQ1LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgZ2FzTGltaXRPdmVycmlkZTogM18wMDBfMDAwLFxuICAgICAgICAgICAgICAgICAgbXVsdGljYWxsQ2h1bms6IDQ1LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgYmFzZUJsb2NrT2Zmc2V0OiAtMjUsXG4gICAgICAgICAgICAgICAgICByb2xsYmFjazoge1xuICAgICAgICAgICAgICAgICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBhdHRlbXB0c0JlZm9yZVJvbGxiYWNrOiAxLFxuICAgICAgICAgICAgICAgICAgICByb2xsYmFja0Jsb2NrT2Zmc2V0OiAtMjAsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3QgdGVuZGVybHlTaW11bGF0b3IgPSBuZXcgVGVuZGVybHlTaW11bGF0b3IoXG4gICAgICAgICAgICBcImh0dHBzOi8vYXBpLnRlbmRlcmx5LmNvXCIsXG4gICAgICAgICAgICBwcm9jZXNzLmVudi5URU5ERVJMWV9VU0VSISxcbiAgICAgICAgICAgIHByb2Nlc3MuZW52LlRFTkRFUkxZX1BST0pFQ1QhLFxuICAgICAgICAgICAgcHJvY2Vzcy5lbnYuVEVOREVSTFlfQUNDRVNTX0tFWSEsXG4gICAgICAgICAgICB2M1Bvb2xQcm92aWRlcixcbiAgICAgICAgICAgIHByb3ZpZGVyLFxuICAgICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICAgLy8gVGhlIHRpbWVvdXQgZm9yIHRoZSB1bmRlcmx5aW5nIGF4aW9zIGNhbGwgdG8gVGVuZGVybHksIG1lYXN1cmVkIGluIG1pbGxpc2Vjb25kcy5cbiAgICAgICAgICAgIDUgKiAxMDAwXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIGNvbnN0IGV0aEVzdGltYXRlR2FzU2ltdWxhdG9yID0gbmV3IEV0aEVzdGltYXRlR2FzU2ltdWxhdG9yKHByb3ZpZGVyLCB2M1Bvb2xQcm92aWRlcik7XG5cbiAgICAgICAgICBjb25zdCBzaW11bGF0b3IgPSBuZXcgRmFsbGJhY2tUZW5kZXJseVNpbXVsYXRvcihwcm92aWRlciwgdGVuZGVybHlTaW11bGF0b3IsIGV0aEVzdGltYXRlR2FzU2ltdWxhdG9yKTtcblxuICAgICAgICAgIGxldCByb3V0ZUNhY2hpbmdQcm92aWRlcjogSVJvdXRlQ2FjaGluZ1Byb3ZpZGVyIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuICAgICAgICAgIGlmIChDQUNIRURfUk9VVEVTX1RBQkxFX05BTUUgJiYgQ0FDSEVEX1JPVVRFU19UQUJMRV9OQU1FICE9PSBcIlwiKSB7XG4gICAgICAgICAgICByb3V0ZUNhY2hpbmdQcm92aWRlciA9IG5ldyBEeW5hbW9Sb3V0ZUNhY2hpbmdQcm92aWRlcih7XG4gICAgICAgICAgICAgIHJvdXRlc1RhYmxlTmFtZTogUk9VVEVTX1RBQkxFX05BTUUhLFxuICAgICAgICAgICAgICByb3V0ZXNDYWNoaW5nUmVxdWVzdEZsYWdUYWJsZU5hbWU6IFJPVVRFU19DQUNISU5HX1JFUVVFU1RfRkxBR19UQUJMRV9OQU1FISxcbiAgICAgICAgICAgICAgY2FjaGluZ1F1b3RlTGFtYmRhTmFtZTogQVdTX0xBTUJEQV9GVU5DVElPTl9OQU1FISxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjaGFpbklkLFxuICAgICAgICAgICAgZGVwZW5kZW5jaWVzOiB7XG4gICAgICAgICAgICAgIHByb3ZpZGVyLFxuICAgICAgICAgICAgICB0b2tlbkxpc3RQcm92aWRlcixcbiAgICAgICAgICAgICAgYmxvY2tlZFRva2VuTGlzdFByb3ZpZGVyLFxuICAgICAgICAgICAgICBtdWx0aWNhbGxQcm92aWRlcjogbXVsdGljYWxsMlByb3ZpZGVyLFxuICAgICAgICAgICAgICB0b2tlblByb3ZpZGVyLFxuICAgICAgICAgICAgICB0b2tlblByb3ZpZGVyRnJvbVRva2VuTGlzdDogdG9rZW5MaXN0UHJvdmlkZXIsXG4gICAgICAgICAgICAgIGdhc1ByaWNlUHJvdmlkZXI6IG5ldyBDYWNoaW5nR2FzU3RhdGlvblByb3ZpZGVyKFxuICAgICAgICAgICAgICAgIG5ldyBPbkNoYWluR2FzUHJpY2VQcm92aWRlcihcbiAgICAgICAgICAgICAgICAgIG5ldyBFSVAxNTU5R2FzUHJpY2VQcm92aWRlcihwcm92aWRlciksXG4gICAgICAgICAgICAgICAgICBuZXcgTGVnYWN5R2FzUHJpY2VQcm92aWRlcihwcm92aWRlcilcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIG5ldyBOb2RlSlNDYWNoZShuZXcgTm9kZUNhY2hlKHsgc3RkVFRMOiAxNSwgdXNlQ2xvbmVzOiBmYWxzZSB9KSlcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgdjNTdWJncmFwaFByb3ZpZGVyLFxuICAgICAgICAgICAgICBvbkNoYWluUXVvdGVQcm92aWRlcjogcXVvdGVQcm92aWRlcixcbiAgICAgICAgICAgICAgdjNQb29sUHJvdmlkZXIsXG4gICAgICAgICAgICAgIHNpbXVsYXRvcixcbiAgICAgICAgICAgICAgcm91dGVDYWNoaW5nUHJvdmlkZXIsXG4gICAgICAgICAgICAgIHRva2VuVmFsaWRhdG9yUHJvdmlkZXIsXG4gICAgICAgICAgICAgIHRva2VuUHJvcGVydGllc1Byb3ZpZGVyLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9O1xuICAgICAgICB9KVxuICAgICAgKTtcblxuICAgICAgZm9yIChjb25zdCB7IGNoYWluSWQsIGRlcGVuZGVuY2llcyB9IG9mIGRlcGVuZGVuY2llc0J5Q2hhaW5BcnJheSkge1xuICAgICAgICAoZGVwZW5kZW5jaWVzQnlDaGFpbiBhcyBhbnkpW2NoYWluSWRdID0gZGVwZW5kZW5jaWVzO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBkZXBlbmRlbmNpZXM6IGRlcGVuZGVuY2llc0J5Q2hhaW4sXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmZhdGFsKHsgZXJyIH0sIGBGYXRhbDogRmFpbGVkIHRvIGJ1aWxkIGNvbnRhaW5lcmApO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfVxufVxuIl19